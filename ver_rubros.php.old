<?php
// obtener_lista_alumnos.php
var_dump($_POST);
echo "Lista de Alumnos ";
if (isset($_POST['sFKey'])) {
    require_once('conect.odbc.php'); // Crear la conexión para la base de datos

    // Obtener la clave del grupo
    $sfkey = $_POST['sFKey'];

    // Consulta PIVOT para obtener la lista de alumnos y calificaciones por temas
    $consulta = "TRANSFORM Sum(CalificacionTema.calificacion) AS calificacion
                 SELECT alumnos.numcont, alumnos.nom, alumnos.ape
                 FROM ((alumnos 
                        INNER JOIN Listas ON alumnos.NumCont = Listas.NumCont) 
                        INNER JOIN TemasPorCalificar ON Listas.sFKey = TemasPorCalificar.sFKey) 
                        INNER JOIN CalificacionTema ON (alumnos.NumCont = CalificacionTema.NumCont) 
                        AND (TemasPorCalificar.idTemaCalificar = CalificacionTema.idTemaCalificar) 
                 WHERE Listas.sFKey='$sfkey'
                 GROUP BY alumnos.numcont, alumnos.nom, alumnos.ape order by alumnos.ape
                 PIVOT temasporcalificar.nombretema";

    $result = odbc_exec($cid, $consulta);

    // Obtener el número de campos y los nombres de los campos
    $numFields = odbc_num_fields($result);
    $fieldNames = array();
    for ($i = 1; $i <= $numFields; $i++) {
        $fieldNames[] = odbc_field_name($result, $i);
    }
    if (count($fieldNames) > 3) {
        // Construir la tabla HTML con la lista de alumnos y calificaciones
        $tabla_html = '<table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Número de Control</th>
                                <th>Nombre</th>';

        // Agregar los nombres de los campos en la cabecera
        for ($i = 3; $i < $numFields; $i++) {
            $consultaidtema="select idtemacalif from temasporcalificar where sfkey=$sfkey and nombretema=$fieldNames[$i];";
            $tabla_html .= '<th>' . utf8_encode($fieldNames[$i]) . '</th>';
        }

        $tabla_html .= '</tr>
                    </thead>
                    <tbody>';

        while (odbc_fetch_row($result)) {
            $numcont = odbc_result($result, 1);
            $nom = odbc_result($result, 2);
            $ape = odbc_result($result, 3);

            $tabla_html .= '<tr>
                            <td>' . $numcont . '</td>
                            <td>' . utf8_encode($ape) . ' ' . utf8_encode($nom) . '</td>';

            // Agregar las calificaciones por tema a la fila
            for ($i = 4; $i <= $numFields; $i++) {
                $calificacion = odbc_result($result, $i);
                $tabla_html .= '<td>' . number_format($calificacion, 0) . '</td>';
            }

            $tabla_html .= '</tr>';
        }

        $tabla_html .= '</tbody></table>';

        // Cerrar la conexión a la base de datos
        odbc_close($cid);

        // Devolver la tabla HTML como respuesta al cliente
        echo $tabla_html;
    }
} else {
    // Si no se proporciona la clave del grupo, devolver un mensaje de error
    echo 'Error: Clave de grupo no proporcionada.';
}

// Consulta para obtener los temas actuales
$consultaTemas = "SELECT DISTINCT nombretema FROM TemasPorCalificar WHERE sfkey='$sfkey'";
$resultTemas = odbc_exec($cid, $consultaTemas);

$temasActuales = array();
while ($row = odbc_fetch_array($resultTemas)) {
    $temasActuales[] = $row['nombretema'];
}

// Función para obtener los rubros actuales
function obtenerRubros() {
    global $idTemaCalificar, $cid;
    $consultaRubros = "SELECT * FROM RubrodeTema WHERE idTemaCalificar=$idTemaCalificar";
    $resultRubros = odbc_exec($cid, $consultaRubros);

    $rubros = array();
    while ($rubro = odbc_fetch_array($resultRubros)) {
        $rubros[] = $rubro;
    }

    return $rubros;
}

// Obtener la lista de rubros después de las operaciones
$rubrosData = obtenerRubros();

// Mostrar el botón para abrir el modal de rubros
echo '<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#rubrosModal">Editar Rubros</button>';

// Modal de rubros
echo '<div class="modal fade" id="rubrosModal" tabindex="-1" role="dialog" aria-labelledby="rubrosModalLabel" aria-hidden="true">';
echo '<div class="modal-dialog" role="document">';
echo '<div class="modal-content">';
echo '<div class="modal-header">';
echo '<h5 class="modal-title" id="rubrosModalLabel">Editar Rubros</h5>';
echo '<button type="button" class="close" data-dismiss="modal" aria-label="Close">';
echo '<span aria-hidden="true">&times;</span>';
echo '</button>';
echo '</div>';
echo '<div class="modal-body">';
echo '<form id="rubrosForm">';
echo '<table class="table" id="rubrosTable">';
echo '<thead>';
echo '<tr>';
echo '<th>Rubro</th>';
echo '<th>Porcentaje (%)</th>';
echo '<th>Acciones</th>';
echo '</tr>';
echo '</thead>';
echo '<tbody>';

foreach ($rubrosData as $rubro) {
    echo '<tr>';
    echo '<td>' . $rubro['nombreRubro'] . '</td>';
    echo '<td>' . $rubro['porcentaje'] . '</td>';
    echo '<td><button type="button" class="btn btn-danger" onclick="eliminarRubro(' . $rubro['idRubroTema'] . ')">Eliminar</button></td>';
    echo '</tr>';
}

echo '</tbody>';
echo '</table>';
echo '<button type="button" class="btn btn-success" onclick="agregarRubro()">Agregar Rubro</button>';
echo '</form>';
echo '</div>';
echo '<div class="modal-footer">';
echo '<button type="button" class="btn btn-primary" onclick="guardarCambios()">Guardar Cambios</button>';
echo '<button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>';
echo '</div>';
echo '</div>';
echo '</div>';
echo '</div>';

// ... (Código posterior)
?>

<!-- Script para manejar la lógica de rubros -->
<script>
// Variables globales para almacenar los datos de los rubros
var rubrosData = <?php echo json_encode($rubrosData); ?>;
var idTemaCalificar = <?php echo $idTemaCalificar; ?>;

// Función para obtener los rubros actuales
function obtenerRubros() {
    // Lógica para obtener los rubros de la base de datos (puedes adaptarla según tus necesidades)
    // ...
}

// Función para mostrar el modal de rubros
function mostrarModalRubros() {
    // Lógica para mostrar el modal (puedes adaptarla según tus necesidades)
    $('#rubrosModal').modal('show');
}

// Función para agregar un nuevo rubro
function agregarRubro() {
    // Lógica para agregar un nuevo rubro al formulario en el modal
    // ...
}

// Función para eliminar un rubro
function eliminarRubro(idRubro) {
    // Lógica para eliminar un rubro del formulario en el modal
    // ...
}

// Función para guardar los cambios en los rubros
function guardarCambios() {
    // Lógica para guardar los cambios en los rubros a la base de datos
    // ...
}
</script>
<?php odbc_close($cid); ?>
